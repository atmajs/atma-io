/*!
 * Atma File System Module v0.2.18
 * Part of the Atma.js Project
 * http://atmajs.com/
 *
 * MIT license
 * http://opensource.org/licenses/MIT
 *
 * (c) 2012, 2016 Atma.js and other contributors
 */
!function(e,r){"use strict";var n,t;"undefined"==typeof exports||e!==exports&&null!=e||(n=t=global),null==n&&(n="undefined"==typeof window?global:window),null==t&&(t=e||n),r(n,t),module.exports=t.io}(this,function(global,exports){"use strict";function obj_extend(e,r){if(null==e&&(e={}),null==r)return e;for(var n in r)e[n]=r[n];return e}function path_getUri(e,r){"string"!=typeof e&&(e=e.toString()),"/"===e[0]&&(e=e.substring(1));var n=new Uri(e);return n.isRelative()===!1?n:r?new Uri(r).combine(n):io.env?io.env.currentDir.combine(n):new Uri("file://"+process.cwd()+"/").combine(n)}function path_combine(e,r){return e?r?("/"===r[0]&&(r=r.substring(1)),"/"===e[e.length-1]?e+r:e+"/"+r):e:r}function path_getDir(e){if(!e)return"/";var r=e.lastIndexOf("/");return r===-1?"":e.substring(r+1,-r)}function path_isSubDir(e,r){var n=path_getDir(e),t=path_getDir(r);return 0===t.toLowerCase().indexOf(n.toLowerCase())}function path_resolveUri(e,r,n){"/"===e[0]&&(r=n,e=e.substring(1));var t=new Uri(e);return t.isRelative()?new net.URI(r).combine(t):t}function path_resolveAppUri(e,r){if("/"===e[0])return e;if("./"===e.substring(0,2)&&(e=e.substring(2)),!r||"file"===e.substring(0,4))return"/";var n=r.lastIndexOf("/");return(n===-1?"/":r.substring(n+1,-n))+e}function path_ensureTrailingSlash(e){return"/"===e[e.length-1]?e:e+"/"}function fs_isDirectory(e){try{return __fs.statSync(e).isDirectory()}catch(e){return!1}}function fs_getStat(e){try{return __fs.statSync(e)}catch(e){return null}}function cfg_get(){var e=io.env.settings,r={};for(var n in e)r[n]=e[n];if(null==global.app||null==app.config||null==app.config.tasks)return r;var n,t=app.current||app.config.tasks[0];for(n in t)r[n]=t[n];return r}function toDir(e){return Uri.combine(normalizePath(e),"/")}function normalizePath(e){return e.replace(/\\/g,"/")}var io={},__fs=require("fs"),_Array_slice=Array.prototype.slice,_=require("atma-utils"),Uri=_.class_Uri,Class=require("atma-class"),logger=global.logger||require("atma-logger"),arr_eachOrSingle,arr_each,arr_any,arr_find,arr_isArray;!function(){arr_eachOrSingle=function(e,r){return arr_isArray(e)===!1?(r(e),e):arr_each(e,r)},arr_any=function(e,r){if(arr_isArray(e)===!1)return!1;for(var n=e.length,t=-1;++t<n;)if(r(e[t],t))return!0;return!1},arr_each=function(e,r){if(null==e)return e;for(var n=e.length,t=-1;++t<n&&r(e[t],t)!==!1;);return e},arr_find=function(e,r){if(null==e)return e;for(var n=e.length,t=-1;++t<n;)if(r(e[t],t))return e[t];return null},arr_isArray=function(e){return Array.isArray(e)}}();var dir_ensure,dir_ensureAsync,dir_exists,dir_existsAsync,dir_symlink,dir_files,dir_filesAsync,dir_remove,dir_removeAsync;!function(){function e(r){for(var n,t,i,o=__fs.readdirSync(r),s=o.length,c=-1;++c<s;)n=o[c],"."!==n&&".."!==n&&(t=r+"/"+n,i=__fs.lstatSync(t),i.isDirectory()?e(t):__fs.unlinkSync(t));__fs.rmdirSync(r)}function r(e,n){function t(e,n){__fs.lstat(e,function(t,i){return t?void n(t):i.isDirectory()?void r(e,n):void __fs.unlink(e,n)})}function i(){__fs.rmdir(e,n)}__fs.readdir(e,function(r,o){if(r)return void n(r);var s=o.length,a=-1;if(0===s)return void i();for(var l,u=c(s,i);++a<s;)l=o[a],"."!==l&&".."!==l?t(path_combine(e,l),u):u()})}function n(e,r,t){var i,o=[];try{i=__fs.readdirSync(e)}catch(e){return console.error("<dir walk>",e),o}null==r&&(r=""),null==t&&(t={depth:0,maxdepth:1/0,directories:!1,symlinks:!1});var s=t.depth,c=t.patterns,l=t.excludes;t.depth++;for(var u,f=0,d=i.length;f<d;f++){u=i[f];var g=a(path_combine(e,u)),h=path_combine(r,u),p=!0;if(null!=g)if(g.isDirectory()){if(g.isSymbolicLink())continue;if(t.directories&&o.push(path_combine(e,u)+"/"),t.depth>=t.maxdepth)continue;var _=path_combine(r,u);if(c){for(var v=!1,y=0,m=c.length;y<m;y++){var b=c[y].rootCount-s,x=c[y].root;if(!b||s>b){v=!0;break}if(0===x.indexOf(_)){v=!0;break}logger(90).warn("<glob> not matched %s | %s",_,x)}if(v===!1)continue}logger(90).warn("<glob> match sub-",_),o=o.concat(n(path_combine(e,u),_,t))}else{if(c){p=!1;for(var y=0,m=c.length;y<m;y++)if(c[y].test(h)){p=!0;break}}if(p&&l)for(var y=0,m=l.length;y<m;y++)if(l[y].test(h)){p=!1;break}p&&o.push(h)}}return t.depth=s,o}function t(e,r,n,i,s,c){function a(e){var r;return function(n){r=r||n,0===--e&&c(r,s)}}function l(r,n){var t=path_combine(e,r);__fs.lstat(t,function(e,t){return e?n():t.isDirectory()?u(r,t,n):(f(r,s),void n())})}function u(o,c,a){if(c.isSymbolicLink())return a();if(i.directories&&s.push(path_combine(r,o)+"/"),n>=g)return a();var l=path_combine(r,o);if(h){for(var u=-1,f=h.length;++u<f;){var p=h[u].rootCount-d,_=h[u].root;if(!p||d>p)break;if(0===_.indexOf(l))break}if(u>=f)return a()}t(path_combine(e,o),l,n,i,s,a)}function f(e,n){var t=path_combine(r,e);h&&o(t,h)===!1||p&&o(t,p)===!0||n.push(t)}var d=n,g=i.maxdepth,h=i.patterns,p=i.excludes;n++,__fs.readdir(e,function(e,r){if(e)return c(e,s);if(0===r.length)return c(null,s);for(var n=-1,t=r.length,i=a(t);++n<t;)l(r[n],i)})}function i(e){return""===e||"/"===e||/^[A-Z]:\/?$/i.test(e)}function o(e,r){for(var n=-1,t=r.length;++n<t;)if(r[n].test(e))return!0;return!1}function s(e){if(null==e)return 1/0;for(var r=0,n=e.length,t=-1;++t<n;)r<e[t].depth&&(r=e[t].depth);return r||1/0}function c(e,r){var n;return function(t){n=n||t,--e<1&&r(n)}}function a(e){try{return __fs.lstatSync(e)}catch(e){return null}}dir_ensure=function(e){if("/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),__fs.existsSync(e)===!1){var r,n=e.substring(0,e.lastIndexOf("/"));if(i(n)===!1&&(r=dir_ensure(n)),r)return r.toString();try{__fs.mkdirSync(e)}catch(e){return e.toString()}}if(!fs_isDirectory(e))return"Target exists, but is not a directory:"+e},dir_ensureAsync=function(e,r){function n(){__fs.mkdir(e,function(e){e&&47===e.errno&&(e=null),r(e)})}e=e.replace(/\/*$/,""),dir_existsAsync(e,function(t,o){if(o)return r();var s=e.substring(0,e.lastIndexOf("/"));i(s)===!1?dir_ensureAsync(s,n):n()})},dir_exists=function(e){return fs_isDirectory(e)},dir_existsAsync=function(e,r){__fs.stat(e,function(e,n){r(e,n&&n.isDirectory())})},dir_files=function(e,r,t,i){return n(e,"",obj_extend(i,{depth:0,maxdepth:s(r),patterns:r,excludes:t}))},dir_filesAsync=function(e){var r=_Array_slice.call(arguments,1),n=r.pop(),i=r.shift(),o=r.shift(),c=r.shift();t(e,"",0,obj_extend(c,{maxdepth:s(i),patterns:i,excludes:o}),[],n)},dir_symlink=function(e,r){try{__fs.symlinkSync(e,r,"junction")}catch(e){logger.error("symlink: bold<%s>",e)}},dir_remove=function(r){if(dir_exists(r)===!1)return!0;try{return e(r),!0}catch(e){return!1}},dir_removeAsync=function(e,n){r(e,n)}}();var file_save,file_saveAsync,file_copy,file_copyAsync,file_exists,file_existsAsync,file_read,file_readAsync,file_remove,file_removeAsync,file_rename,file_renameAsync;!function(){function e(e){return e.substring(0,e.lastIndexOf("/")+1)}function r(e,r){for(var n=65536,t=new Buffer(n),i=1,o=__fs.openSync(e,"r"),s=__fs.openSync(r,"w"),c=0;i>0;)i=__fs.readSync(o,t,0,n,c),__fs.writeSync(s,t,0,i),c+=i;return __fs.closeSync(o),__fs.closeSync(s)}file_save=function(e,r,n){var t=dir_ensure(path_getDir(e));if(t)return void log_error("file_save",e);try{__fs.writeFileSync(e,r,n)}catch(e){log_error("file_save",e.toString())}},file_saveAsync=function(e,r,t,i){dir_ensureAsync(path_getDir(e),function(o){return o?i(o):void __fs.writeFile(e,r,t||n,i)})},file_copy=function(e,n){if(__fs.existsSync(e)===!1)return void log_error("file_copy 404",e);var t=dir_ensure(path_getDir(n));if(t)return void log_error("file_copy Target error",n);try{r(e,n)}catch(e){log_error("file_copy",e.toString())}},file_copyAsync=function(e,r,n){function t(e,t){return t!==!0?n({code:404}):void dir_ensureAsync(path_getDir(r),i)}function i(t){if(t)return void n(t);var i=__fs.createReadStream(e).on("error",function(r){logger.log("readstream error",e,r),n&&n(r),n=null}),o=__fs.createWriteStream(r).on("error",function(e){logger.log("writestream error",r,e),n&&n(e),n=null}).on("close",function(){n&&n(),n=null});i.pipe(o)}file_existsAsync(e,t)},file_exists=function(e){return __fs.existsSync(e)&&__fs.statSync(e).isFile()},file_existsAsync=function(e,r){__fs.stat(e,function(e,n){var t=n&&n.isFile();e&&34===e.errno&&(t=!1,e=null),r(e,t)})},file_read=function(e,r){try{return __fs.readFileSync(e,r)}catch(e){log_error("file_read",e.toString())}return""},file_readAsync=function(e,r,n){__fs.readFile(e,{encoding:r},n)},file_remove=function(e){if(file_exists(e)===!1)return!0;try{__fs.unlinkSync(e)}catch(e){return log_error("file_remove",e.toString()),!1}return!0},file_removeAsync=function(e,r){__fs.unlink(e,function(e){e&&34===e.errno&&(e=null),r(e)})},file_rename=function(r,n){if(file_exists(r)===!1)return log_error("file_rename 404",r),!1;try{__fs.renameSync(r,e(r)+n)}catch(e){return log_error("file_rename",e.toString()),!1}return!0},file_renameAsync=function(r,n,t){__fs.rename(r,e(r)+n,function(e){t(e,null==e)})};var n={encoding:"utf8"}}();var glob_getCalculatedPath,glob_matchPath,glob_parsePatterns,glob_parseDirs,glob_toRegExp,glob_getStrictPath,glob_getRelativePath;!function(){glob_getCalculatedPath=function(e,r){var n=r.indexOf("*"),t=r.lastIndexOf("/",n),i=t===-1?null:r.substring(0,t);if(!t)return e;var o=e.toLowerCase().indexOf(i.toLowerCase());return o===-1?(logger.warn("[substring not found]",e,i),e):e.substring(o+i.length)},glob_matchPath=function(e,r){return"/"===r[0]&&(r=r.substring(1)),"/"===e[0]&&(e=e.substring(1)),glob_toRegExp(e).test(r)},glob_parsePatterns=function(e,r){if(null==e)return null;if(null==r&&(r=[]),Array.isArray(e))return e.forEach(function(n){e(n,r)}),r;if(e instanceof RegExp)return r.push(e),r;if("string"==typeof e){var n=e;"/"===n[0]&&(n=n.substring(1));var t=glob_toRegExp(n),i=glob_parseDirs(n);return t.depth=i[0],t.rootCount=i[1],t.root=i[2],r.push(t),r}return logger.error("<glob> Unsupported pattern",e),r},glob_parseDirs=function(e){"/"===e[0]&&(e=e.substring(1));var r=0,n=e.split("/");r=e.indexOf("**")!==-1?1/0:n.length,n.pop();for(var t=0;t<n.length;t++)n[t].indexOf("*")!==-1&&n.splice(t);return[r,n.length,n.join("/").toLowerCase()]},glob_toRegExp=function(e){var r="\\^$*+?.()|{}[]",n="",t=-1,i=e.length;for(e=e.replace(/(\*\*\/){2,}/g,"**/");++t<i;){var o=e[t];switch(o){case"?":n+=".";break;case"*":if("*"===e[t+1]){0===t&&/[\\\/]/.test(e[t+2])&&(n+=".+",t+=2),n+=".+",t++;break}n+="[^/]+";break;case"{":var s=e.indexOf("}",t);if(~s){n+="("+e.substring(t+1,s).replace(/,/g,"|")+")",t=s;break}n+=o;break;case"[":var s=e.indexOf("]",t);if(~s){n=e.substring(t,s),t=s;break}n+=o;break;default:~r.indexOf(o)&&(n+="\\"),n+=o}}return n="^"+n+"$",new RegExp(n,"i")},glob_getStrictPath=function(e){var r=e.indexOf("*");return r===-1?(logger.error("glob.js [path is not a glob pattern]",e),null):e.substring(0,e.lastIndexOf("/",r)+1)},glob_getRelativePath=function(e){var r=e.indexOf("*");return r===-1?(logger.error("glob.js [path is not a glob pattern]",e),null):e.substring(e.lastIndexOf("/",r)+1)}}();var rgx_prepairString;!function(){rgx_prepairString=function(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}}();var cli_confirm,cli_prompt;!function(){function e(){var e=require("readline");r=e.createInterface({input:process.stdin,output:process.stdout})}cli_prompt=function(e,r){t.create(new i(e,r))},cli_confirm=function(e,r){t.create(new o(e+" (y): ",r))};var r,n,t=Class({collection:[],busy:!1,Static:{create:function(i){null==r&&(e(),n=new t),n.collection.push(i),n.process()}},Self:{process:function(){this.busy||0!==this.collection.length&&(this.busy=!0,this.collection.shift().process().always(this.next))},next:function(){this.busy=!1,this.process()}}}),i=Class({Base:Class.Deferred,text_:">",callback_:null,Construct:function(e,r){this.text_=e,this.callback_=r},process:function(){return r.resume(),process.stdout.write("\n"),r.question(this.text_,this.onInput.bind(this)),this},onInput:function(e){r.pause(),this.callback_&&this.callback_(e),this.resolve(e)}}),o=Class({Base:i,Construct:function(){var e=this.callback_;this.callback_=function(r){e(/^y|yes$/gi.test(r))}},Override:{onInput:function(e){return e?void this.super(e):void this.process()}}})}();var log_error,log_info;!function(e){function r(r,n){var t=_Array_slice.call(n);t.unshift(r),e.log.apply(e,t)}log_error=function(){r(n.red,arguments)},log_info=function(){r(n.cyan,arguments)};var n="[atma-io]"}(logger);var mainFile=new Uri(normalizePath(process.mainModule.filename)),platform=process.platform,__cwd=toDir(process.cwd());return io.env={applicationDir:new Uri(mainFile.toDir()),currentDir:new Uri(__cwd),get newLine(){return Object.defineProperty(this,"newLine",{value:require("os").EOL}),this.newLine},get appdataDir(){var e;switch(platform){case"win32":case"win64":e=process.env.APPDATA||process.env.HOME;break;case"darwin":e=process.env.HOME;break;default:e=process.env.HOME}return null==e?(logger.error("<io.env> Unknown AppData Dir"),Object.defineProperty(this,"appdataDir",{value:this.applicationDir}),this.applicationDir):(e=new Uri(toDir(e)),"darwin"===platform&&(e=e.combine("Library/Application Support/")),e=e.combine("."+mainFile.file+"/"),Object.defineProperty(this,"appdataDir",{value:e}),e)}},function(){function e(e,r){var n=new Class.Deferred;return r(n,e,e.uri.toLocalFile()),n}function r(e){return function(r){return r?void e.reject(r):void e.resolve.apply(e,_Array_slice.call(arguments,1))}}function n(e,r){var n=r||{encoding:"utf8",skipHooks:!1,hooks:null};if(null==e)return n;switch(typeof e){case"string":n.encoding=e;break;case"object":e.hasOwnProperty("encoding")&&(n.encoding=e.encoding),e.hasOwnProperty("skipHooks")&&(n.skipHooks=e.skipHooks),e.hasOwnProperty("hooks")&&(n.hooks=e.hooks)}return"buffer"===n.encoding&&(n.encoding=null),n}function t(e,r,n,t,o){var s=n.hooks||i;return null==s||n.skipHooks===!0?void(o&&o()):o?void s.triggerAsync(e,r,t,o):void s.trigger(e,r,t)}var i,o,s={},c=!0;io.File=Class({Construct:function(e,r){if(this.uri=path_getUri(e),e=this.uri.toLocalFile(),c&&s.hasOwnProperty(e)&&!1!==(r&&r.cached))return s[e];if(this.__proto__===io.File.prototype){var n=r&&r.factory||o,t=n&&n.resolveHandler(this.uri);if(null!=t)return new t(this.uri,r)}return s[e]=this},read:function(e){if(null!=this.content)return this.content;var r=n(e),i=this.uri.toLocalFile();return this.content=file_read(i,r.encoding),t("read",this,r,e),this.content},readAsync:function(r){return e(this,function(e,i,o){function s(n,o){return n?e.reject(n):(i.content=o,void t("read",i,a,r,c))}function c(r){return r?e.reject(r):void e.resolve(i.content,i)}if(null!=i.content)return void e.resolve(i.content,i);var a=n(r);file_readAsync(o,a.encoding,s)})},write:function(e,r){if(null!=e&&(this.content=e),null==this.content)return logger.error("io.file.write: Content is empty"),this;var i=this.uri.toLocalFile(),o=n(r);return t("write",this,o,r),file_save(i,this.content,o),this},writeAsync:function(i,o){return e(this,function(e,s,c){function a(){file_saveAsync(c,s.content,l,r(e))}if(s.content=i=i||s.content,null==i)return void e.reject(Error("Content is undefined"));var l=n(o);t("write",s,l,o,a)})},copyTo:function(e){var r=this.uri.toLocalFile(),n=path_getUri(e),t=n.file?n.toLocalFile():n.combine(this.uri.file).toLocalFile(),i=r.substr(-25).replace(/([^\/]+)$/,"green<bold<$1>>").color,o=t.substr(-25).replace(/([^\/]+)$/,"green<bold<$1>>").color;return log_info("copy:",i,o),file_copy(r,t),this},copyToAsync:function(n){return e(this,function(e,t,i){file_copyAsync(i,path_getUri(n).toLocalFile(),r(e))})},exists:function(){return file_exists(this.uri.toLocalFile())},existsAsync:function(){return e(this,function(e,n,t){file_existsAsync(t,r(e))})},rename:function(e){return file_rename(this.uri.toLocalFile(),e)},renameAsync:function(n){return e(this,function(e,t,i){file_renameAsync(i,n,r(e))})},remove:function(){return file_remove(this.uri.toLocalFile())},removeAsync:function(){return e(this,function(e,n,t){file_removeAsync(t,r(e))})},replace:function(e,r,n){var t=this.read(n);return t=t.replace(e,r),this.write(t),t},replaceAsync:function(r,n,t){return e(this,function(e,i){i.readAsync(t).fail(e.failDelegate()).done(function(t){t=t.replace(r,n),i.writeAsync().fail(e.failDelegate()).done(function(){e.resolve(null,t)})})})},watch:function(e){io.watcher.watch(this.uri.toLocalFile(),e)},unwatch:function(e){io.watcher.unwatch(this.uri.toLocalFile(),e)},stats:function(){return fs_getStat(this.uri.toLocalFile())},Static:{clearCache:function(e){if(c!==!1){if(0===arguments.length)return void(s={});if(null!=e){var r;return"string"==typeof e?(r=path_getUri(e).toLocalFile(),s.hasOwnProperty(r)===!1&&47===e.charCodeAt(0)&&(r=Uri.combine(__cwd,e))):e.uri?r=e.uri.toLocalFile():e.toLocalFile&&(r=e.toLocalFile()),s.hasOwnProperty(r)===!1?void logger.log("io.File - not in cache -",r):void delete s[r]}}},disableCache:function(){s={},c=!1},enableCache:function(){c=!0},registerFactory:function(e){o=e},getFactory:function(){return o},registerHookHandler:function(e){i=e},getHookHandler:function(){return i},get Factory(){return o},get Middleware(){return i}}})}(),function(){["exists","existsAsync","read","readAsync","write","writeAsync","remove","removeAsync","rename","renameAsync","copyTo","copyToAsync"].forEach(function(e){io.File[e]=function(){var r=arguments[0],n=_Array_slice.call(arguments,1),t=new io.File(r),i=t[e];if(null==i)throw Error("Virtual File not implements method "+e);return i.apply(t,n)}})}(),function(){function e(e,r){var n=new Class.Deferred;return r(n,e,e.uri.toLocalDir()),n}function r(e){return function(r){return r?void e.reject(r):void e.resolve.apply(e,_Array_slice.call(arguments,1))}}var n=io.Directory=Class({Construct:function(e){return e instanceof n?e:null==e||"/"===e?void(this.uri=io.env.currentDir):("string"==typeof e&&"/"!==e[e.length-1]&&(logger.warn("@ directory path should end with slash. Adding...",e),/\.\w+$/.test(e)===!1&&(e+="/")),this.uri=new Uri(e),this.uri.isRelative()&&io.env&&(this.uri=io.env.currentDir.combine(this.uri)),void delete this.uri.file)},exists:function(){return dir_exists(this.uri.toLocalDir())},existsAsync:function(){return e(this,function(e,n,t){dir_existsAsync(t,r(e))})},ensure:function(){return dir_ensure(this.uri.toLocalDir()),this},ensureAsync:function(){return e(this,function(e,n,t){dir_ensureAsync(t,r(e))})},readFiles:function(e,r){var n=glob_parsePatterns(e),t=glob_parsePatterns(r),i=this;return this.files=dir_files(this.uri.toLocalDir(),n,t).map(function(e){return new io.File(i.uri.combine(e))}),this},read:function(e,r){var n=glob_parsePatterns(e),t=glob_parsePatterns(r),i=this;return dir_files(this.uri.toLocalDir(),n,t,{directories:!0}).map(function(e){var r=i.uri.combine(e);return"/"===e[e.length-1]?new io.Directory(r):new io.File(r)})},readFilesAsync:function(r,n){var t=glob_parsePatterns(r);glob_parsePatterns(n);return e(this,function(e,r,i){dir_filesAsync(i,t,n,function(n,t){return n?void e.reject(n):(r.files=t.map(function(e){return new io.File(r.uri.combine(e))}),void e.resolve(r.files,r))})})},readAsync:function(r,n){var t=glob_parsePatterns(r);glob_parsePatterns(n);return e(this,function(e,r,i){dir_filesAsync(i,t,n,{directories:!0},function(n,t){if(n)return void e.reject(n);var i=t.map(function(e){var n=r.uri.combine(e);return"/"===e[e.length-1]?new io.Directory(n):new io.File(n)});e.resolve(i,r)})})},copyTo:function(e,r){function n(){if(++a>=c)return void t.resolve();var e,l=s[a],u=l.uri.toRelativeString(i);if(e=o.combine(u),r.verbose!==!0&&io.File.exists(e)){var f="File already exists: {0}. Replace? ";return f.format(u),void cli_prompt(f,function(r){r&&l.copyTo(e),n()})}l.copyTo(e),n()}var t=new Class.Deferred;Array.isArray(this.files)===!1&&this.readFiles(),r=r||{verbose:!1};var i=this.uri,o=path_getUri(e),s=this.files,c=s.length,a=-1;return n(),t},copyToAsync:function(e,r){function n(e,n){function t(){n()}var i,a=c[e],l=a.uri.toRelativeString(o);if(i=s.combine(l),r.verbose!==!0&&io.File.exists(i)){var u="File already exists: {0}. Replace? ";return u.format(l),void cli_prompt(u,function(e){e===!0&&a.copyToAsync(i).done(t).fail(n)})}a.copyToAsync(i).done(t).fail(n)}var t=new Class.Deferred;if(Array.isArray(this.files)===!1){var i=this;return this.readFilesAsync().done(function(){i.copyToAsync(e,r).done(t.resolveDelegate()).fail(t.rejectDelegate())}).fail(t.rejectDelegate()),t}r=r||{verbose:!1};for(var o=this.uri,s=path_getUri(e),c=this.files,a=c.length,l=-1,u=new Class.Await;++l<a;)n(l,u.delegate());return u.done(t.resolveDelegate()).fail(t.rejectDelegate()),t},getName:function(){return/([^\/]+)\/?$/.exec(this.uri.path)[1]},rename:function(e){if(!e)return void logger.error("<dir:rename> New Name is not defined");var r=this.uri.toLocalFile(),n=r.replace(/[^\/]+\/?$/g,e);logger.log("<dir:rename>",r,n),__fs.renameSync(r,n)},renameAsync:function(n){return e(this,function(e,t,i){if(!n)return void e.reject("Name is undefined");var o=i.replace(/[^\/]+\/?$/g,n);__fs.rename(i,o,r(e))})},remove:function(){dir_remove(this.uri.toLocalDir())},removeAsync:function(){return e(this,function(e,n,t){dir_removeAsync(t,r(e))})},watch:function(e){io.watcher.watch(this.uri.toLocalFile(),e)},unwatch:function(e){io.watcher.unwatch(this.uri.toLocalFile(),e)},Static:{symlink:dir_symlink}})}(),function(){["exists","existsAsync","readFiles","readFilesAsync","read","readAsync","ensure","ensureAsync","rename","renameAsync","remove","removeAsync","copyTo","copyToAsync"].forEach(function(e){io.Directory[e]=function(){var r=arguments[0],n=Array.prototype.slice.call(arguments,1),t=new io.Directory(r);return t[e].apply(t,n)}})}(),function(){var e=Class({Construct:function(e,r,n,t){this.regexp=e,this.method=r,this.handler=n,this.zIndex=t},run:function(e,r,n){if(e===this.method&&this.regexp.test(r.uri.toString())!==!1)return"function"!=typeof this.handler?void(this.handler[e]&&this.handler[e](r,n)):void this.handler(r,n)},runAsync:function(e,r,n,t){if(e!==this.method)return void t();if(this.regexp.test(r.uri.toString())===!1)return void t();var i=this.handler;if("function"!=typeof i){if(i[e+"Async"])return void i[e+"Async"](r,n,t);if(i[e])try{i[e](r,n)}catch(e){return void t(e)}return void t()}i(r,n),t()},canHandle:function(e,r){return(null==r||r===this.method)&&this.regexp.test(e)}}),r=io.File.Hooks=Class({hooks:null,Construct:function(){this.hooks=[]},register:function(r,n,t,i){var o=r;if(1===arguments.length&&(o=r.regexp,n=r.method,t=r.handler,i=r.zIndex),"string"==typeof t){if(t=io.File.middleware[t],null==t)return logger.error("<io.File> Hook handler not found",t),this;if("function"!=typeof t&&null==t[n])return logger.error("<io.File> Hook handler does not support `%s` method",n),this}return this.contains(n,t,o)===!1&&this.hooks.push(new e(o,n,t,i||0)),this},contains:function(e,r,n){for(var t,i=this.hooks.length;--i>-1;)if(t=this.hooks[i],t.method===e&&t.handler===r){if(null!==n&&n.toString()!==t.regexp.toString())continue;return!0}return!1},unregister:function(e,r){"string"==typeof r&&(r=io.File.middleware[r]),this.hooks=this.hooks.filter(function(n){return!(n.method===e&&n.handler===r)})},trigger:function(e,r,n){return this.getHooksForPath(r.uri.toString(),e).forEach(function(t){t.run(e,r,n)}),this},triggerAsync:function(e,r,t,i){var o=r.uri.toString(),s=this.getHooksForPath(o,e);new n(s).process(e,r,t,i)},clear:function(){return this.hooks=[],this},getHooksForPath:function(e,r){return this.hooks.filter(function(n){return n.canHandle(e,r)}).sort(function(e,r){var n=e.zIndex,t=r.zIndex;return n===t?0:e.zIndex<r.zIndex?1:-1})}});io.File.registerHookHandler(new r);var n=Class.Collection(e,{Base:Class.Serializable,index:-1,cb:null,method:null,file:null,config:null,process:function(e,r,n,t){this.index=-1,this.cb=t,this.method=e,this.file=r,this.config=n,this.next()},Self:{next:function(e){if(e)return void this.cb(e);if(++this.index>=this.length)return void this.cb();var r=this[this.index];r.runAsync(this.method,this.file,this.config,this.next)}}})}(),function(){function e(e,n){for(var t,i=e.length,o=-1;++o<i;)if(t=e[o],r(t.regexp,n))return t;return null}function r(e,n){return Array.isArray(e)?e.some(function(e){return r(e,n)}):(e.lastIndex=0,e.test(n))}function n(e){function r(e,r){return function(){var r=new Class.Deferred;try{var n=e.apply(this,Array.from(arguments));return r.resolve(n)}catch(e){return r.reject(e)}}}var n="function"==typeof e?e.prototype:e;for(var t in n){var i=n[t];if("function"==typeof i&&t.indexOf("Async")===-1){var o=t+"Async";null==n[o]&&(n[o]=r(i,t))}}}var t=Class({handlers:null,Construct:function(){this.handlers=[]},registerHandler:function(e,r){n(r),this.handlers.push({handler:r,regexp:e})},unregisterHandler:function(e,r){for(var n,t=e.toString(),i=this.handlers.length,o=-1;++o<i;)if(n=this.handlers[o],n.regexp.toString()===t)if(void 0!==r){if(r===n)return void this.handlers.splice(o,1)}else this.handlers.splice(o,1),o--,i--},resolveHandler:function(r){var n=r.toString(),t=e(this.handlers,n);return t?t.handler:null}});io.File.registerFactory(new t)}(),function(){var e="change",r={};io.watcher={watch:function(t,i){return r[t]?void r[t].on(e,i):__fs.existsSync(t)===!1?void logger.error("<watcher> File not exists",t):(r[t]=new n(t),void r[t].on(e,i))},unwatch:function(n,t){var i=r[n];return null==i?void logger.warn("<watcher> No exists",n):void(t&&(i.off(e,t),0!==i._listeners.length)||(i.close(),delete r[n]))}};var n=Class({Base:Class.EventEmitter,Construct:function(e,r){this.path=e,this.fswatcher=__fs.watch(e,this.changed)},Self:{changed:function(){this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(this.reportChange,100)},reportChange:function(){this.trigger(e,this.path)}},close:function(){this.fswatcher.close(),this.off()}})}(),function(){function registerMiddleware(e){var r=io.File.getHookHandler();for(var n in e){var t=e[n];arr_isArray(t)!==!1?arr_each(t,registerHookDelegate(r,n)):logger.warn("Middleware list for %s is not an array",n)}}function registerHookDelegate(e,r){return function(n){registerHook(e,r,n)}}function registerHook(e,r,n){var t=n.split(":"),i=t[0],o=t[1],s=io.File.middleware[i];if(null==s)try{var c=require(i);s=io.File.middleware[i],null==s&&(s=c)}catch(e){}if(null==s)return void logger.error("Middleware not defined",i);if("object"==typeof s&&null==s[o]&&null==s[o+"Async"])return void logger.error("Middleware not defined for action",o,i);r=rgx_prepairString(r);var a="\\."+r+"$",l="\\."+r+"\\?",u="\\."+r+"#",f=a+"|"+l+"|"+u;e.register(new RegExp(f),o,s)}io.File.middleware={},function(){var e=require("jshint").JSHINT;io.File.middleware.hint=function(r,n){if(n=null!=n&&"object"==typeof n?n.jshint:cfg_get().jshint,null!=n){var t=n.globals,i=n.options,o=n.ignore,s=n.nolog;if(!(r.uri.file.indexOf(".min.")>-1||o&&o.hasOwnProperty(r.uri.file))){"string"!=typeof r.content&&(r.content=r.content.toString());var c=Date.now(),a=e(r.content,i,t);if(logger.log("%s [%sms] %s",a?"Success".green:("Warn "+e.errors.length).red,Date.now()-c,r.uri.file),!a&&!s){var l,u,f=io.File.middleware.importer,d=r.uri.toLocalFile(),g=f.map_parse(r.content,d);e.errors.forEach(function(e){if(e){g&&(l=f.map_getFileAt(g,e.line),null==l?e.line>g[0].start&&logger.error("<hint:importedFile> file not resolved at",e.line):(null!=u&&u.file===l.file||logger.log(" ",l.file.trim().magenta),u=l,e.line-=l.start));var r=e.evidence,n=e.character;logger.log("[yellow<%s>:yellow<%s>] bold<%s>".color,"L"+e.line,"C"+n,e.reason),r&&logger.log("  "+r.trim().cyan)}})}}}}}(),function(){var e=require("uglify-js");global.UglifyJS=e,io.File.middleware.uglify=function(r,n){null==n&&(n=cfg_get());var t=n.minify,i=t&&n.sourceMap;if(t||"string"!=typeof r.content){logger.log("Uglify... [start]").log("");var o;o=t?n.uglify||{global_defs:{DEBUG:!1}}:{sequences:!1,properties:!1,dead_code:!1,drop_debugger:!1,unsafe:!1,conditionals:!1,comparisons:!1,evaluate:!1,booleans:!1,loops:!1,unused:!1,hoist_funs:!1,hoist_vars:!1,if_return:!1,join_vars:!1,cascade:!1,side_effects:!1,global_defs:{DEBUG:!1}};var s,c,a=Date.now();if("defines"in n&&(o.global_defs=n.defines),s=e.Compressor(o),c=r.content,"string"==typeof c)try{c=e.parse(r.content,{filename:r.uri.toLocalFile()})}catch(e){return void logger.error("<uglify>:",e.message)}c.figure_out_scope(),c=c.transform(s),t&&(c.figure_out_scope(),c.compute_char_frequency(),c.mangle_names());var l,u;i&&(u=e.SourceMap({file:r.uri.file})),l=e.OutputStream({beautify:!t,comments:/^!/,source_map:u}),c.print(l),r.content=l.toString(),i&&(r.sourceMap=u.toString()),logger.log("Uglify... [end %sms]",Date.now()-a)}}}(),io.File.middleware.cssmin=function(e,r){null==r&&(r=cfg_get()),r.minify&&(e.content=require("clean-css").process(e.content))},io.File.middleware.coffee=function(e){var r=require("coffee-script");"string"!=typeof e.content&&(e.content=e.content.toString()),e.content=r.compile(e.content)},function(){function process(code,index,defines){reg_expression.lastIndex=index||0;var match=reg_expression.exec(code);if(null==match)return code;var expression=match[4],expressionEnd=match.index+match[0].length,doAction=null;try{doAction=!!eval(stringifyDefines(defines)+";"+expression)}catch(e){logger.warn("Conditional derective: ",e.toString())}reg_inlineEnd.lastIndex=match.index;var reg_inlineEndMatch=reg_inlineEnd.exec(code),area="//"===match[1]||reg_inlineEndMatch&&reg_inlineEndMatch.index===match.index?"uncommented":"commented",out={index:expressionEnd,derectiveStart:match.index};return"commented"===area&&doAction===!0?code=uncomment(code,out):"uncommented"===area&&doAction===!1?code=comment(code,out):out.index=match.index+1,process(code,out.index,defines)}function uncomment(e,r){reg_commentEnd.lastIndex=r.index;var n=reg_commentEnd.exec(e),t=n.index+n[0].length,i=e.substring(0,r.derectiveStart)+e.substring(r.index,n.index)+e.substring(t);return r.index=r.derectiveStart+(n.index-r.index),i}function comment(e,r){reg_endIf.lastIndex=r.index;var n=reg_endIf.exec(e),t=e.substring(0,r.derectiveStart)+e.substring(n.index+n[0].length);return r.index=r.derectiveStart,t}function stringifyDefines(e){if(!e)return"";var r=[];for(var n in e)switch(typeof e[n]){case"string":r.push(String.format('var %1="%2"',n,e[n]));continue;case"number":case"boolean":r.push(String.format("var %1=%2",n,e[n]));continue;case"object":r.push(String.format("var %1=%2",n,JSON.stringify(e[n])));continue}return r.join(";")}io.File.middleware.condcomments=function(e,r){var n,t=e.content;r=r||cfg_get(),null!=r&&(n=r.defines||r.uglify&&r.uglify.global_defs,null!=n&&("string"!=typeof t&&(t=t.toString()),e.content=process(t,0,n)))};var reg_commentEnd=/\*\//g,reg_inlineEnd=/\/\*[ \t]*if[^\n\r]+\*\//g,reg_endIf=/(\/\*[\t ]*endif[\t ]*\*\/)|([ \t]*\/\/[ \t]*endif[ \t]*$)/gm,reg_expression=/^[ \t]*((\/\/)|(\/\*))[ \t]*if[ \t]*(([^\s]+$)|(\([^)\n\r]+\)))/gm}(),function(){function e(e){var i=e.content;"string"!=typeof i&&(i=i.toString()),y.test(i)&&(e.content=i=t(i)),v.test(i)&&(e.content=i=n(i)),g.test(i)&&(e.content=r(e.uri,i))}function r(e,r){function n(e){return"/"===e[0]?io.env.currentDir.combine(e.substring(1)):i.combine(e)}function t(e){var r,t=e[e.length-1];return"/"===t?(r=n(e+"exports."+o),io.File.exists(r)?r:n(e+"*."+o)):(/\.\w+$/.test(e)===!1&&(e+="."+o),n(e))}var i=e,o="js",d=s(r);return p.test(r)&&(r=r.replace(p,function(e,r){return i=n(r),""})),_.test(r)&&(r=r.replace(_,function(e,r){return o=r,""})),r.replace(g,function(r,n,i,o,s){var g,h,p,_,v=i||s;return v?(g=t(v),v=g.toString(),h=a(v),p=c(r),_=h.map(function(r){var n={file:"VIRTUAL".bold.yellow},t=(r.uri||n).file,i="File Import "+t+" into "+e.file;return logger.log(i),u(r,p,h.length>1)}).join(d),n&&(_=l(_)),r.replace("import","source")+d+_+d+r.replace("import","end:source")):(f("Path can not be extracted",r),r)})}function n(e){return e.replace(v,function(e,r){var n=d[r];return null==n?(f("Unknown IMPORT function",r),e):n()})}function t(e){return e.replace(y,function(){return f('"import version" is deprecated. Use importer function: %IMPORT(VERSION)%'),"'"+d.version()+"'"})}function i(e,r){if(h.test(e)===!1)return null;for(var n,t,i,o=e.split(/\r\n|\n|\r/g),s=[],c=o.length,a=0;a<c;a++)if(h.test(o[a])){for(t=i=a+1,n=o[a].replace("source","end:source");++i<c&&o[i]!==n;);
if(i===c)return logger.error("<map:imports> Ending was not found",{ending:n}),null;s.push({file:o[a].replace(/[ \t]*\/\/[ \t]*source/g,""),start:t,end:i-1})}return s}function o(e,r){if(null==e)return null;for(var n,t,i=0,o=e.length;i<o;i++)if(t=e[i],t.start<=r&&t.end>=r){if(null==n){n=t;continue}t.start>n.start&&(n=t)}return n}var s,c,a,l,u,f=logger.error.bind(logger,"AtmaIO[importer]:".error);!function(){s=function(e){var r=/(\r\n)|(\r)|(\n)/.exec(e);return r&&r[0]||io.env.newLine},c=function(e){var r=/^[ \t]+/.exec(e);return r&&r[0]||""},a=function(e){if(e.indexOf("*")!==-1){var r=new io.Directory(glob_getStrictPath(e));return r.exists()===!1?(f("Directory not found",r.uri.toLocalDir()),[]):r.readFiles(glob_getRelativePath(e)).files}var n=new io.File(e);return n.exists()===!1?(f("File does not exists",n.uri.toLocalFile()),[]):[n]},u=function(e,r,n){var t=e.read().toString(),i=s(t);return r&&(t=t.split(i).map(function(e){return r+e}).join(i)),n&&(t=r+"// source "+e.uri.file+i+t),t},l=function(e){return e=e.replace(/[\n\r]/g,"\\n").replace(/"/g,'\\"'),'"'+e+'"'}}();var d={version:function(e){var r=function(){return e.apply(this,arguments)};return r.toString=function(){return e.toString()},r}(function(){var e=arr_find(["package.json","bower.json","component.json","package.yml"],function(e){return io.File.exists(e)});if(null==e)return f('Version requested but no "package" found'),"0.0.0";var r=io.File.read(e),n=r&&r.version;return null==n?(f("Invalid package",e),"0.0.0"):n}),year:function(){return(new Date).getFullYear()}};io.File.middleware.importer=e;var g=/^[\t ]*\/\/[ #]*import(:string)?[ ]+(([^\s'"]+)|('|"([^'"]+))'|")[ \t]*$/gm,h=/^[\t ]*\/\/[ #]*source(:string)?[ ]+(([^\s'"]+)|('|"([^'"]+))'|")[ \t]*$/gm,p=/^[\t ]*\/\/[ #]*import:base[ ]([^\s'"]+)$/m,_=/^[\t ]*\/\/[ #]*import:extension[ ]([^\s'"]+)$/m,v=/%IMPORT\(([\w\- _\/]+)\)%/g,y=/\/\*[ #]*import[ ]+version[ ]*\*\//gi;e.map_parse=i,e.map_getFileAt=o}(),function(){var e;io.File.middleware.yml={read:function(r){if(null==e&&(e=require("yamljs")),"string"==typeof r.content)try{var n=r.content.replace(/\t/g,"  ");r.content=e.parse(n)}catch(e){logger.error("<yaml:parse> ",e)}},write:function(r){null==e&&(e=require("yamljs")),null!=r.content&&"object"==typeof r.content&&(r.content=e.stringify(JSON.parse(JSON.stringify(r.content)),4))}}}(),function(){io.File.middleware.json={read:function(e){if("string"==typeof e.content)try{e.content=JSON.parse(e.content)}catch(e){logger.error("<json:parser>",e)}},write:function(e,r){if(null!=e.content&&"object"==typeof e.content)try{var n=r&&r.minify?null:4;e.content=JSON.stringify(e.content,null,n).replace(/\n/g,io.env.newLine)}catch(e){logger.error("<json:stringify> ",e)}}}}(),io.File.registerExtensions=registerMiddleware,registerMiddleware({js:["condcomments:read","hint:read","uglify:write"],css:["cssmin:write"],coffee:["coffee:read","hint:read","uglify:write"],yml:["yml:read","yml:write"],json:["json:read","json:write"]})}(),io.glob={matchPath:glob_matchPath,readFiles:function(e){var r=glob_getStrictPath(e),n=glob_getRelativePath(e);return new io.Directory(r).readFiles(n).files},read:function(e){var r=glob_getStrictPath(e),n=glob_getRelativePath(e);return new io.Directory(r).read(n)},readAsync:function(e,r){var n=glob_getStrictPath(e),t=glob_getRelativePath(e);return new io.Directory(n).readAsync(t).done(function(e,n){r(null,e,n)}).fail(function(e){r(e)})}},io.settings=function(e){e.extensions&&io.File.registerExtensions(e.extensions)},null!=exports.io&&"object"==typeof exports.io?void obj_extend(exports.io,io):void(exports.io=io)});
//# sourceMappingURL=io.min.js.map